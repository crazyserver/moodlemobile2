<ion-header>
    <ion-toolbar>
        <ion-buttons slot="start">
            <ion-back-button [attr.aria-label]="'core.back' | translate"></ion-back-button>
        </ion-buttons>
        <ion-title><core-format-text *ngIf="quiz" [text]="quiz.name" contextLevel="module" [contextInstanceId]="quiz.coursemodule" [courseId]="courseId"></core-format-text></ion-title>

        <ion-buttons slot="primary">
            <ion-button id="addon-mod_quiz-connection-error-button" slot="icon-only //TODO: mode to icon" [hidden]="!autoSaveError" (click)="showConnectionError($event)" [attr.aria-label]="'core.error' | translate">
                <ion-icon name="alert"></ion-icon>
            </ion-button>
            <ion-button *ngIf="navigation && navigation.length" slot="icon-only //TODO: mode to icon" [attr.aria-label]="'addon.mod_quiz.opentoc' | translate" (click)="openNavigation()">
                <ion-icon name="bookmark"></ion-icon>
            </ion-button>
        </ion-buttons>
    </ion-toolbar>
</ion-header>
<ion-content>
    <!-- Navigation arrows and time left. -->
    <ion-toolbar *ngIf="loaded && endTime && questions && questions.length && !quizAborted && !showSummary" color="light" ion-fixed>
        <ion-title>
            <core-timer [endTime]="endTime" (finished)="timeUp()" [timerText]="'addon.mod_quiz.timeleft' | translate" align="center"></core-timer>
        </ion-title>
        <ion-buttons slot="primary">
            <ion-button slot="icon-only //TODO: mode to icon" *ngIf="previousPage >= 0" (click)="changePage(previousPage)" [title]="'core.previous' | translate">
                <ion-icon name="arrow-back" md="ios-arrow-back"></ion-icon>
            </ion-button>
            <ion-button slot="icon-only //TODO: mode to icon" *ngIf="nextPage >= -1" (click)="changePage(nextPage)" [title]="'core.next' | translate">
                <ion-icon name="arrow-forward" md="ios-arrow-forward"></ion-icon>
            </ion-button>
        </ion-buttons>
    </ion-toolbar>
    <core-loading [hideUntil]="loaded" [class.core-has-fixed-timer]="endTime">
        <!-- Navigation arrows and time left. -->
        <ion-toolbar *ngIf="!endTime && questions && questions.length && !quizAborted && !showSummary" color="light">
            <ion-buttons slot="primary">
                <ion-button slot="icon-only //TODO: mode to icon" *ngIf="previousPage >= 0" (click)="changePage(previousPage)" [title]="'core.previous' | translate">
                    <ion-icon name="arrow-back" md="ios-arrow-back"></ion-icon>
                </ion-button>
                <ion-button slot="icon-only //TODO: mode to icon" *ngIf="nextPage >= -1" (click)="changePage(nextPage)" [title]="'core.next' | translate">
                    <ion-icon name="arrow-forward" md="ios-arrow-forward"></ion-icon>
                </ion-button>
            </ion-buttons>
        </ion-toolbar>
        <!-- Button to start attempting. -->
        <div class="ion-padding" *ngIf="!attempt">
            <ion-button expand="block" (click)="start()">{{ 'addon.mod_quiz.startattempt' | translate }}</ion-button>
        </div>

        <!-- Questions -->
        <form name="addon-mod_quiz-player-form" *ngIf="questions && questions.length && !quizAborted && !showSummary" #quizForm>
            <div *ngFor="let question of questions">
                <ion-card id="addon-mod_quiz-question-{{question.slot}}">
                    <!-- "Header" of the question. -->
                    <ion-item-divider>
                        <h2 *ngIf="question.number" class="inline">{{ 'core.question.questionno' | translate:{$a: question.number} }}</h2>
                        <h2 *ngIf="!question.number" class="inline">{{ 'core.question.information' | translate }}</h2>
                        <ion-note class="ion-text-wrap" slot="end" *ngIf="question.status || question.readableMark">
                            <p *ngIf="question.status" class="block">{{question.status}}</p>
                            <p *ngIf="question.readableMark">{{ question.readableMark }}</p>
                        </ion-note>
                    </ion-item-divider>
                    <!-- Body of the question. -->
                    <core-question class="ion-text-wrap" [question]="question" [component]="component" [componentId]="quiz.coursemodule" [attemptId]="attempt.id" [usageId]="attempt.uniqueid" [offlineEnabled]="offline" contextLevel="module" [contextInstanceId]="quiz.coursemodule" [courseId]="courseId" (onAbort)="abortQuiz()" (buttonClicked)="behaviourButtonClicked($event)"></core-question>
                </ion-card>
            </div>
        </form>

        <!-- Go to next or previous page. -->
        <ion-grid class="ion-text-wrap" *ngIf="questions && questions.length && !quizAborted && !showSummary">
            <ion-row>
                <ion-col *ngIf="previousPage >= 0" >
                    <ion-button expand="block" slot="start //TODO: mode to icon" color="light" (click)="changePage(previousPage)">
                        <ion-icon name="arrow-back" md="ios-arrow-back"></ion-icon>
                        {{ 'core.previous' | translate }}
                    </ion-button>
                </ion-col>
                <ion-col *ngIf="nextPage >= -1">
                    <ion-button expand="block" slot="end //TODO: mode to icon" (click)="changePage(nextPage)">
                        {{ 'core.next' | translate }}
                        <ion-icon name="arrow-forward" md="ios-arrow-forward"></ion-icon>
                    </ion-button>
                </ion-col>
            </ion-row>
        </ion-grid>

        <!-- Summary -->
        <ion-card *ngIf="!quizAborted && showSummary && summaryQuestions && summaryQuestions.length" class="addon-mod_quiz-table">
            <ion-card-header class="ion-text-wrap">
                <h2>{{ 'addon.mod_quiz.summaryofattempt' | translate }}</h2>
            </ion-card-header>
            <!-- "Header" of the summary table. -->
            <ion-item class="ion-text-wrap">
                <ion-row class="ion-align-items-center">
                    <ion-col size="3" class="ion-text-center hidden-phone"><b>{{ 'addon.mod_quiz.question' | translate }}</b></ion-col>
                    <ion-col size="3" class="ion-text-center hidden-tablet"><b>#</b></ion-col>
                    <ion-col size="9" class="ion-text-center"><b>{{ 'addon.mod_quiz.status' | translate }}</b></ion-col>
                </ion-row>
            </ion-item>
            <!-- Lift of questions of the summary table. -->
            <ng-container *ngFor="let question of summaryQuestions">
                <ion-item (click)="changePage(question.page, false, question.slot)" *ngIf="question.number" [attr.aria-label]="'core.question.questionno' | translate:{$a: question.number}" [attr.detail-push]="!quiz.isSequential && canReturn ? true : null">
                    <ion-row class="ion-align-items-center">
                        <ion-col size="3" class="ion-text-center">{{ question.number }}</ion-col>
                        <ion-col size="9" class="ion-text-center ion-text-wrap">{{ question.status }}</ion-col>
                    </ion-row>
                </ion-item>
            </ng-container>
            <!-- Button to return to last page seen. -->
            <ion-item *ngIf="canReturn">
                <ion-button expand="block" (click)="changePage(attempt.currentpage)">{{ 'addon.mod_quiz.returnattempt' | translate }}</ion-button>
            </ion-item>
            <!-- Due date warning. -->
            <ion-item class="ion-text-wrap" *ngIf="attempt.dueDateWarning">
                {{ attempt.dueDateWarning }}
            </ion-item>
            <!-- Time left (if quiz is timed). -->
            <core-timer *ngIf="endTime" [endTime]="endTime" (finished)="timeUp()" [timerText]="'addon.mod_quiz.timeleft' | translate"></core-timer>
            <!-- List of messages explaining why the quiz cannot be submitted. -->
            <ion-item class="ion-text-wrap" *ngIf="preventSubmitMessages.length">
                <p class="item-heading">{{ 'addon.mod_quiz.cannotsubmitquizdueto' | translate }}</p>
                <p *ngFor="let message of preventSubmitMessages">{{message}}</p>
                <ion-button expand="block" slot="end //TODO: mode to icon" [href]="moduleUrl" core-link>
                    {{ 'core.openinbrowser' | translate }}
                    <ion-icon name="open"></ion-icon>
                </ion-button>
            </ion-item>
            <!-- Button to submit the quiz. -->
            <ion-item *ngIf="!attempt.finishedOffline && !preventSubmitMessages.length">
                <ion-button expand="block" (click)="finishAttempt(true)">{{ 'addon.mod_quiz.submitallandfinish' | translate }}</ion-button>
            </ion-item>
        </ion-card>

        <!-- Quiz aborted -->
        <ion-card *ngIf="attempt && (((!questions || !questions.length) && !showSummary) || quizAborted)">
            <ion-item class="ion-text-wrap">
                <p>{{ 'addon.mod_quiz.errorparsequestions' | translate }}</p>
            </ion-item>
            <ion-item>
                <ion-button expand="block" slot="end //TODO: mode to icon" [href]="moduleUrl" core-link>
                    {{ 'core.openinbrowser' | translate }}
                    <ion-icon name="open"></ion-icon>
                </ion-button>
            </ion-item>
        </ion-card>
    </core-loading>
</ion-content>
